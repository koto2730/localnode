name: Release Build and Deploy

on:
  push:
    branches:
      - main  # mainブランチにマージされた時に実行

permissions:
  contents: write

jobs:
  # ============================================================
  # Android AAB (Google Play用)
  # ============================================================
  build-android-aab:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - run: flutter pub get

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_CONTENT }}" | base64 --decode > android/app/release-keystore.jks

      - name: Build AAB
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          flutter build appbundle --release \
            --build-number=$(( ${{ github.run_number }} + 28 ))

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: build/app/outputs/bundle/release/app-release.aab

  # ============================================================
  # Android APK (GitHub Releases用)
  # ============================================================
  build-android-apk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - run: flutter pub get

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_CONTENT }}" | base64 --decode > android/app/release-keystore.jks

      - name: Build APK
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          flutter build apk --release \
            --build-number=$(( ${{ github.run_number }} + 28 ))

      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/localnode-android.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/localnode-android.apk

  # ============================================================
  # Windows
  # ============================================================
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Create zip archive
        run: Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath localnode-windows-x64.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: localnode-windows-x64.zip

  # ============================================================
  # Linux
  # ============================================================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.5'
          channel: 'stable'
          cache: true

      - run: flutter pub get

      - name: Build Linux
        run: flutter build linux --release

      - name: Create tar.gz archive
        run: tar -czf localnode-linux-x64.tar.gz -C build/linux/x64/release/bundle .

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: localnode-linux-x64.tar.gz

  # ============================================================
  # Linux ARM64 (Raspberry Pi等)
  # ============================================================
  build-linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev

      - name: Set up Flutter (ARM64 manual install)
        run: |
          git clone https://github.com/flutter/flutter.git --depth 1 -b stable $HOME/flutter
          echo "$HOME/flutter/bin" >> $GITHUB_PATH

      - name: Flutter precache
        run: flutter precache --linux

      - run: flutter pub get

      - name: Build Linux
        run: flutter build linux --release

      - name: Create tar.gz archive
        run: tar -czf localnode-linux-arm64.tar.gz -C build/linux/arm64/release/bundle .

      - name: Upload Linux ARM64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: localnode-linux-arm64.tar.gz

  # ============================================================
  # ドラフトリリース作成 (Windows, Linux, Android APK)
  # ============================================================
  release:
    runs-on: ubuntu-latest
    needs: [build-android-apk, build-windows, build-linux, build-linux-arm64]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          tag_name: build-${{ github.run_number }}
          name: Build ${{ github.run_number }}
          files: |
            artifacts/windows-x64/localnode-windows-x64.zip
            artifacts/linux-x64/localnode-linux-x64.tar.gz
            artifacts/linux-arm64/localnode-linux-arm64.tar.gz
            artifacts/android-apk/localnode-android.apk

  # ============================================================
  # Google Play デプロイ (AAB)
  # ============================================================
  deploy-google-play:
    runs-on: ubuntu-latest
    needs: [build-android-aab]
    steps:
      - name: Download AAB artifact
        uses: actions/download-artifact@v4
        with:
          name: android-aab
          path: artifacts/aab

      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          packageName: com.ictglab.localnode
          releaseFiles: artifacts/aab/app-release.aab
          track: internal
          status: completed
          changesNotSentForReview: false
